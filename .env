# ─── Server ───────────────────────────────────────────────────────────────────
HOST=0.0.0.0
PORT=3001
LOG_LEVEL=info
LOG_FORMAT=json
LOG_REQUESTS=false
TRUST_PROXY=true

# ─── Redis ────────────────────────────────────────────────────────────────────
REDIS_URL=redis://127.0.0.1:6379
REDIS_MAX_RETRIES_PER_REQUEST=3
REDIS_ENABLE_READY_CHECK=true
REDIS_CONNECT_TIMEOUT=10000

# ─── Auth ─────────────────────────────────────────────────────────────────────
JOIN_TOKEN_SECRET=a-very-long-and-random-secret-for-production-use-12345678901234567890

# ─── Room limits ──────────────────────────────────────────────────────────────
# Max users per room (keep low to limit broadcast fan-out cost)
ROOM_MAX_PARTICIPANTS=20
# Room auto-expires after 10 minutes of inactivity
ROOM_KEY_TTL_MS=600000
# QR token rotates every 60s
QR_ROTATION_MS=60000

# ─── Message size limits ──────────────────────────────────────────────────────
# Max raw WS frame: 256 KB
MAX_WS_MSG_BYTES=262144
# Max encrypted payload: 64 KB
MAX_APP_CIPHERTEXT_BYTES=65536

# ─── Rate limiting & flood protection ────────────────────────────────────────
# Per-connection: 60 messages per 10 seconds (prevents spam)
MAX_MSGS_PER_10S=60
# Per-connection: 512 KB per 10 seconds
MAX_BYTES_PER_10S=524288
# Per-IP WebSocket connections
MAX_CONNS_PER_IP=10
# Global WebSocket connection cap (protects memory)
MAX_TOTAL_CONNECTIONS=2000
# Room creates per IP per minute
MAX_ROOM_CREATES_PER_IP_PER_MIN=5

# ─── Performance tuning ───────────────────────────────────────────────────────
# Ping every 25s, timeout dead connections after 10s
WS_PING_INTERVAL_MS=25000
WS_PING_TIMEOUT_MS=10000
# HTTP keep-alive (slightly above Cloudflare's 90s idle timeout)
HTTP_KEEP_ALIVE_TIMEOUT_MS=95000

# ─── Feature toggles ──────────────────────────────────────────────────────────
FEATURE_HEALTH_ENDPOINT=true
FEATURE_METRICS_ENDPOINT=true
FEATURE_READINESS_ENDPOINT=true
FEATURE_GRACEFUL_SHUTDOWN=true
FEATURE_CORS=true
FEATURE_SECURITY_HEADERS=true
FEATURE_REQUEST_ID=true
FEATURE_IP_TRACKING=true
FEATURE_TOKEN_REPLAY_PROTECTION=true
FEATURE_SLOW_CONSUMER_PROTECTION=true
SLOW_CONSUMER_BUFFER_THRESHOLD=524288
FEATURE_AUTO_ROOM_CLEANUP=true
FEATURE_DETAILED_ERRORS=false

# ─── CORS ─────────────────────────────────────────────────────────────────────
CORS_ALLOWED_ORIGINS=*
CORS_ALLOW_CREDENTIALS=false

# ─── Security headers ─────────────────────────────────────────────────────────
CSP_DIRECTIVES=default-src 'none'; connect-src 'self'; frame-ancestors 'none'; base-uri 'none'
HSTS_MAX_AGE=31536000
HSTS_INCLUDE_SUBDOMAINS=false
HSTS_PRELOAD=false

# ─── Observability ────────────────────────────────────────────────────────────
METRICS_EXPORT_PROMETHEUS=false
METRICS_COLLECTION_INTERVAL_MS=15000
LOG_HEALTH_CHECK_FAILURES=false
GRACEFUL_SHUTDOWN_TIMEOUT_MS=30000
